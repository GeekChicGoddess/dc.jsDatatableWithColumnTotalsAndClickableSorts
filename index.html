<!DOCTYPE html>
<html lang="en">

<head>
  <title>dc.js Table of Aggregated Data with titles</title>
  <meta charset="UTF-8">


  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>

  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.0.0/dc.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/dc/2.0.0/dc.css" />


  <!--       IF YOU USE DC.JS VERSION 1 (ALSO CHANGE TO RENDERLET CODE IN THE JAVASCRIPT BELOW)-->
  <!--
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dc/1.7.5/dc.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/dc/1.7.5/dc.css" />
-->
</head>

<body>

  <div class="container">
    <table id="test" class="table table-striped">
      <thead>
        <tr>
          <th onClick="orderByExpt()" onmouseover="" style="cursor: pointer;">Experiments</th>
          <th onClick="orderByRun()" onmouseover="" style="cursor: pointer;">#Run</th>
          <th onClick="orderByAvg()" onmouseover="" style="cursor: pointer;">Avg(Speed)</th>
        </tr>
        <!--  what the html will look like in the total row
<tr class="dc-table-group info">
  <td class="dc-table-label" colspan="3">"Experiments Total"</td>
  <td class="totaRuns">10</td>
</tr>
-->
      </thead>
    </table>

    <h6><a href="https://github.com/GeekChicGoddess/dc.jsDatatableWithColumnTotalsAndClickableSorts">Code</a></h6>
  </div>

  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.2/require.js"></script>

  <script>
    function orderByExpt() {

      chart.sortBy((function(d) {
        return d.value.expt;
      }));
      chart.render();
    }

    function orderByRun() {

      chart.sortBy((function(d) {
        return d.value.total;
      }));
      chart.render();
    }

    function orderByAvg() {
      chart.sortBy((function(d) {
        return d.value.avg;
      }));
      chart.render();

    }
    var chart = dc.dataTable("#test");


    d3.json("data.json", function(error, experiments) {

      var ndx = crossfilter(experiments),
        exptDimension = ndx.dimension(function(d) {

          return +d.expt;
        }),
        groupedDimension = exptDimension.group().reduce(
          function(p, v) {

            ++p.number;
            p.total += +v.speed;
            p.avg = Math.round(p.total / p.number);
            return p;
          },
          function(p, v) {
            --p.number;
            p.total -= +v.speed;
            p.avg = (p.number == 0) ? 0 : Math.round(p.total / p.number);

            return p;
          },
          function() {
            return {
              number: 0,
              total: 0,
              avg: 0
            }
          }),
        groupBy = function(p) {
          return "Experiments Totals";
        };
      chart
        .width(768)
        .height(480)
        .dimension(groupedDimension)
        .group(groupBy)
        .columns([function(d) {
            return d.key
          },
          function(d) {
            return d.value.number
          },
          function(d) {
            return d.value.avg
          }
        ])
        .sortBy((function(d) {
          return d.value.avg
        }))
        .order(d3.descending)
      chart.render();

    });
    var colspan = null;

    //  IF USING VERSION 1 DC.JS SWITCH OUT PRETRANSITION LINE WITH THIS RENDERLET LINE
    //    chart.renderlet(function(chart) {

    chart.on('pretransition', function(chart) {

      var grouprow = chart.selectAll('tr.dc-table-group').classed('info', true);
      // fetch previous colspan only once
      if (colspan === null) {
        colspan = +grouprow.select('td').attr('colspan') - 2;
      }

      grouprow.selectAll('td.dc-table-label').attr('colspan', colspan);


      var totalRuns = grouprow.selectAll('td.totalRuns ').data(function(d) {

        return [d.values.map(function(d) {

          return d.value.number;
        }).reduce(function(a, b) {
          return a + b;
        })];
      });

      totalRuns.enter().append('td').attr('class', 'totalRuns ');

      totalRuns.text(function(d) {
        return d;
      });

      var count = 0;
      var totalAvg = grouprow.selectAll('td.totalAvg').data(function(d) {
        return [d.values.map(function(d) {
          count++;
          return d.value.avg;
        }).reduce(function(a, b) {
          return a + b;
        })];
      });


      // could grabbing the data be any more convoluted than this?  grab it and return it divided by count
      totalAvg.enter()[0][0].__data__ = Math.round(totalAvg.enter()[0][0].__data__ / count);

      totalAvg.enter().append('td').attr('class', 'totalAvg');

      totalAvg.text(function(d) {
        return d;
      });

    });

  </script>
</body>

</html>
